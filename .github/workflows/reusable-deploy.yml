name: Reusable Deploy Workflow

on:
  workflow_call:
    inputs:
      environment:
        required: true
        type: string
        description: 'Environment to deploy (DES, PRE, PROD)'
      version:
        required: true
        type: string
        description: 'Build version to deploy'
      artifact-name:
        required: true
        type: string
        description: 'Name of the build artifact'
    secrets:
      api-key:
        required: true
        description: 'API key for the environment'
    outputs:
      deployment-url:
        description: 'URL where the application was deployed'
        value: ${{ jobs.deploy.outputs.url }}

jobs:
  deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    outputs:
      url: ${{ steps.set-url.outputs.url }}
    environment:
      name: ${{ inputs.environment }}
    
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.artifact-name }}

      - name: Set environment URL
        id: set-url
        run: |
          case "${{ inputs.environment }}" in
            DES)
              echo "url=https://des.example.com" >> $GITHUB_OUTPUT
              ;;
            PRE)
              echo "url=https://pre.example.com" >> $GITHUB_OUTPUT
              ;;
            PROD)
              echo "url=https://prod.example.com" >> $GITHUB_OUTPUT
              ;;
          esac

      - name: Deploy application
        env:
          API_KEY: ${{ secrets.api-key }}
          ENVIRONMENT: ${{ inputs.environment }}
          VERSION: ${{ inputs.version }}
        run: |
          echo "ðŸš€ Deploying version $VERSION to $ENVIRONMENT"
          echo "ðŸ“¦ Artifact: ${{ inputs.artifact-name }}"
          echo "ðŸŒ URL: ${{ steps.set-url.outputs.url }}"
          
          # Aqui vocÃª adiciona seus comandos especÃ­ficos de deploy
          # Exemplos:
          
          # Para AWS:
          # aws configure set aws_access_key_id $AWS_ACCESS_KEY_ID
          # aws configure set aws_secret_access_key $AWS_SECRET_ACCESS_KEY
          # aws s3 sync dist/ s3://bucket-$ENVIRONMENT/ --delete
          
          # Para Azure:
          # az login --service-principal -u $AZURE_CLIENT_ID -p $AZURE_CLIENT_SECRET --tenant $AZURE_TENANT_ID
          # az webapp deployment source config-zip --resource-group rg-$ENVIRONMENT --name app-$ENVIRONMENT --src dist.zip
          
          # Para servidor via SSH:
          # scp -r dist/* user@server-$ENVIRONMENT:/var/www/app/
          # ssh user@server-$ENVIRONMENT 'sudo systemctl restart app'
          
          echo "âœ… Deploy completed successfully!"

      - name: Health check
        run: |
          echo "ðŸ” Running health check..."
          sleep 5
          # curl -f ${{ steps.set-url.outputs.url }}/health || exit 1
          echo "âœ… Health check passed!"

      - name: Deployment summary
        run: |
          echo "### ðŸŽ‰ Deployment Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Version**: ${{ inputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: ${{ steps.set-url.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: âœ… Success" >> $GITHUB_STEP_SUMMARY
