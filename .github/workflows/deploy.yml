name: Deploy

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Run ID do build'
        required: true
        type: string
      environment:
        description: 'Ambiente para deploy'
        required: true
        type: choice
        options:
          - des
          - pre
          - prod

jobs:
  deploy:
    name: Deploy Build #${{ github.event.inputs.run_id }} to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Get Build Info
        id: build_info
        run: |
          echo "üì¶ Buscando informa√ß√µes do Build (Run ID: ${{ github.event.inputs.run_id }})..."
          
          # Busca informa√ß√µes do build pela API
          BUILD_INFO=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/runs/${{ github.event.inputs.run_id }}")
          
          BUILD_NUMBER=$(echo "$BUILD_INFO" | jq -r '.run_number')
          ARTIFACT_NAME=$(echo "$BUILD_INFO" | jq -r '.name')
          
          if [ -z "$BUILD_NUMBER" ] || [ "$BUILD_NUMBER" = "null" ]; then
            echo "‚ùå Build n√£o encontrado"
            exit 1
          fi
          
          echo "‚úÖ Build #$BUILD_NUMBER encontrado"
          echo "build_number=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "artifact_name=build-v1.0.$BUILD_NUMBER" >> $GITHUB_OUTPUT
          
          # Atualiza o nome do job com o n√∫mero do build
          echo "::notice title=Deploy::Build #$BUILD_NUMBER ‚Üí ${{ github.event.inputs.environment }}"

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ steps.build_info.outputs.artifact_name }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ github.event.inputs.run_id }}

      - name: Deploy to ${{ github.event.inputs.environment }}
        run: |
          echo "üöÄ Deploying to ${{ github.event.inputs.environment }}"
          echo "Build Number: #${{ steps.build_info.outputs.build_number }}"
          echo "Run ID: ${{ github.event.inputs.run_id }}"
          
          # Encontra o artefato baixado
          if [ -f build/info.txt ]; then
            echo "Version info:"
            cat build/info.txt
          fi
          
          if [ -f teste.txt ]; then
            cat teste.txt
          fi
          
          echo "‚úÖ Deploy to ${{ github.event.inputs.environment }} completed!"

      - name: Deployment summary
        run: |
          echo "### üöÄ Deploy Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number**: [#${{ steps.build_info.outputs.build_number }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.event.inputs.run_id }})" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID**: ${{ github.event.inputs.run_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact**: ${{ steps.build_info.outputs.artifact_name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚úÖ Deployment successful!" >> $GITHUB_STEP_SUMMARY

      - name: Deployment tracking
        run: |
          echo "üìä Registrando deployment..."
          
          BUILD_NUMBER="${{ steps.build_info.outputs.build_number }}"
          VERSION="${{ steps.build_info.outputs.artifact_name }}"
          
          # Cria deployment no GitHub (aparece na aba Environments)
          DEPLOYMENT=$(curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/deployments" \
            -d "{
              \"ref\": \"master\",
              \"environment\": \"${{ github.event.inputs.environment }}\",
              \"description\": \"Deploy Build #$BUILD_NUMBER ($VERSION) to ${{ github.event.inputs.environment }}\",
              \"auto_merge\": false,
              \"required_contexts\": []
            }")
          
          DEPLOYMENT_ID=$(echo "$DEPLOYMENT" | jq -r '.id')
          
          # Marca deployment como sucesso
          curl -s -X POST \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/deployments/$DEPLOYMENT_ID/statuses" \
            -d "{
              \"state\": \"success\",
              \"description\": \"Build #$BUILD_NUMBER deployed successfully\",
              \"environment_url\": \"https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}\"
            }"
          
          echo "‚úÖ Deployment registrado (ID: $DEPLOYMENT_ID)"
          echo "üìç Veja em: https://github.com/${{ github.repository }}/deployments"
