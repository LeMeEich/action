name: Deploy

on:
  workflow_dispatch:
    inputs:
      build_number:
        description: 'NÃºmero do Build (ex: 13)'
        required: true
        type: string
      environment:
        description: 'Ambiente para deploy'
        required: true
        type: choice
        options:
          - des
          - pre
          - prod

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment }}
    
    steps:
      - name: Find Build Run ID
        id: find_run
        run: |
          echo "Procurando Build #${{ github.event.inputs.build_number }}..."
          
          # Busca o run_id do build com o nÃºmero especificado usando API REST
          RESPONSE=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/build.yml/runs?per_page=100&status=success")
          
          RUN_ID=$(echo "$RESPONSE" | jq -r '.workflow_runs[] | select(.run_number == ${{ github.event.inputs.build_number }}) | .id')
          
          if [ -z "$RUN_ID" ] || [ "$RUN_ID" = "null" ]; then
            echo "âŒ Build #${{ github.event.inputs.build_number }} nÃ£o encontrado ou nÃ£o completou com sucesso"
            exit 1
          fi
          
          echo "âœ… Build #${{ github.event.inputs.build_number }} encontrado (Run ID: $RUN_ID)"
          echo "run_id=$RUN_ID" >> $GITHUB_OUTPUT

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: build-v1.0.${{ github.event.inputs.build_number }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.find_run.outputs.run_id }}

      - name: Deploy to ${{ github.event.inputs.environment }}
        run: |
          echo "ðŸš€ Deploying to ${{ github.event.inputs.environment }}"
          echo "Build Number: ${{ github.event.inputs.build_number }}"
          echo "Artifact: build-v1.0.${{ github.event.inputs.build_number }}"
          
          # Encontra o artefato baixado
          if [ -f build/info.txt ]; then
            echo "Version info:"
            cat build/info.txt
          fi
          
          if [ -f teste.txt ]; then
            cat teste.txt
          fi
          
          echo "âœ… Deploy to ${{ github.event.inputs.environment }} completed!"

      - name: Deployment summary
        run: |
          echo "### ðŸš€ Deploy Completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: ${{ github.event.inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Build Number**: ${{ github.event.inputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Artifact**: build-v1.0.${{ github.event.inputs.build_number }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Deployment successful!" >> $GITHUB_STEP_SUMMARY
